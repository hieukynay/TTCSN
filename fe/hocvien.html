<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang H·ªçc vi√™n ‚Ä¢ EnglishCenter</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
<header class="site-header">
  <nav class="nav container">
    <a class="brand" href="index.html">EnglishCenter</a>
    <ul class="nav-list">
      <li class="active"><a href="hocvien.html">Trang h·ªçc vi√™n</a></li>
      <li><a href="#" id="logoutBtn">ƒêƒÉng xu·∫•t</a></li>
    </ul>
  </nav>
</header>

<main class="container">
  <h1>Xin ch√†o, H·ªçc vi√™n üëã</h1>

  <!-- L·ªõp ƒëang m·ªü + ƒëƒÉng k√Ω -->
  <section class="card">
    <h2>L·ªõp ƒëang m·ªü</h2>
    <div class="form grid-2">
      <label><span>Nh·∫≠p ID l·ªõp ƒë·ªÉ ƒëƒÉng k√Ω</span><input id="enrollClassId" type="number" placeholder="VD: 101" /></label>
      <div><button id="enrollBtn" class="btn">ƒêƒÉng k√Ω l·ªõp</button></div>
    </div>
    <table id="openClasses">
      <thead><tr><th>M√£ l·ªõp</th><th>T√™n l·ªõp</th><th>Kh√≥a h·ªçc</th><th>Ph√≤ng</th><th>L·ªãch</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- B√†i t·∫≠p -->
  <section class="card">
    <h2>B√†i t·∫≠p</h2>
    <div class="form grid-2">
      <label><span>M√£ l·ªõp ƒë·ªÉ t·∫£i b√†i t·∫≠p</span><input id="asmClassId" type="number" placeholder="VD: 101" /></label>
      <div><button id="loadAsmBtn" class="btn">T·∫£i danh s√°ch b√†i t·∫≠p</button></div>
    </div>
    <table id="asmTbl">
      <thead><tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th><th>H·∫°n n·ªôp</th><th>N·ªôp b√†i</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Thanh to√°n -->
  <section class="card">
    <h2>Thanh to√°n h·ªçc ph√≠</h2>
    <div class="form grid-2">
      <label><span>S·ªë ti·ªÅn (VND)</span><input id="payAmount" type="number" value="500000" step="1000" /></label>
      <label><span>Ghi ch√∫</span><input id="payNote" type="text" placeholder="H·ªçc ph√≠ th√°ng..." /></label>
      <div style="display:flex;gap:8px;align-items:flex-end;">
        <button id="payBtn" class="btn">T·∫°o giao d·ªãch (n·ªôi b·ªô)</button>
        <button id="momoBtn" class="btn btn-outline">Thanh to√°n MoMo</button>
      </div>
    </div>
    <h3>L·ªãch s·ª≠ thanh to√°n</h3>
    <table id="payTable">
      <thead><tr><th>Th·ªùi gian</th><th>S·ªë ti·ªÅn</th><th>Ph∆∞∆°ng th·ª©c</th><th>Tr·∫°ng th√°i</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- L·ªãch h·ªçc -->
  <section class="card">
    <h2>L·ªãch h·ªçc</h2>
    <table id="scheduleTbl">
      <thead><tr><th>Ng√†y</th><th>B·∫Øt ƒë·∫ßu</th><th>K·∫øt th√∫c</th><th>M√£ l·ªõp</th><th>Ph√≤ng</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer class="site-footer"><div class="container"><p>¬© 2025 EnglishCenter.</p></div></footer>
<script src="assets/app.js"></script>
<script>
  const auth = requireRole('HocVien');
  if (!auth) throw new Error('No auth');

  const tbodyOpen = document.querySelector('#openClasses tbody');
  const tbodyPay  = document.querySelector('#payTable tbody');
  const tbodySch  = document.querySelector('#scheduleTbl tbody');
  const tbodyAsm  = document.querySelector('#asmTbl tbody');

  async function loadOpenClasses(){
    tbodyOpen.innerHTML = '<tr><td colspan="5" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await StudentAPI.listOpenClasses(); const data = await res.json();
      if (!data || !data.length){ tbodyOpen.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ l·ªõp.</td></tr>'; return; }
      tbodyOpen.innerHTML = data.map(l=>`
        <tr>
          <td>${l.maLopHoc ?? '-'}</td>
          <td>${l.tenLopHoc ?? '-'}</td>
          <td>${l.khoaHoc?.tenKhoaHoc ?? '-'}</td>
          <td>${l.phongHoc ?? '-'}</td>
          <td>${l.lichHoc ?? '-'}</td>
        </tr>`).join('');
    }catch{ tbodyOpen.innerHTML = '<tr><td colspan="5" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  }

  document.getElementById('enrollBtn').onclick = async ()=>{
    const id = parseInt(document.getElementById('enrollClassId').value, 10);
    if (!id){ alert('Nh·∫≠p m√£ l·ªõp h·ª£p l·ªá'); return; }
    try{ 
      const res = await StudentAPI.enrollClass(id, auth.userId);
      if (!res.ok) throw new Error();
      alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
    }catch{ alert('ƒêƒÉng k√Ω th·∫•t b·∫°i'); }
  };

  // Assignments
  document.getElementById('loadAsmBtn').onclick = async ()=>{
    const classId = parseInt(document.getElementById('asmClassId').value, 10);
    if (!classId){ alert('Nh·∫≠p m√£ l·ªõp'); return; }
    tbodyAsm.innerHTML = '<tr><td colspan="4" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await StudentAPI.listAssignments(classId); const data = await res.json();
      if (!data || !data.length){ tbodyAsm.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√†i t·∫≠p.</td></tr>'; return; }
      tbodyAsm.innerHTML = data.map(a=>`
        <tr>
          <td>${a.id ?? a.maBaiTap ?? '-'}</td>
          <td>${a.tieuDe ?? '-'}</td>
          <td>${a.hanNop ?? '-'}</td>
          <td>
            <details>
              <summary>N·ªôp b√†i</summary>
              <div class="form" style="margin-top:8px">
                <label><span>N·ªôi dung tr·∫£ l·ªùi</span><textarea id="ans-${a.id}"></textarea></label>
                <label><span>File (tu·ª≥ ch·ªçn)</span><input type="file" id="file-${a.id}" /></label>
                <button class="btn btn-sm" onclick="submitAsm(${a.id})">G·ª≠i</button>
              </div>
            </details>
          </td>
        </tr>`).join('');
    }catch{ tbodyAsm.innerHTML = '<tr><td colspan="4" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  };

  window.submitAsm = async (asmId)=>{
    try{
      const text = document.getElementById('ans-'+asmId)?.value || '';
      const file = document.getElementById('file-'+asmId)?.files?.[0] || null;
      const r = await StudentAPI.submitAssignment(asmId, auth.userId, text, file);
      if (!r.ok) throw 0;
      alert('N·ªôp b√†i th√†nh c√¥ng!');
    }catch{ alert('N·ªôp b√†i th·∫•t b·∫°i'); }
  };

  // Payments
  async function loadPayments(){
    tbodyPay.innerHTML = '<tr><td colspan="4" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await StudentAPI.paymentHistory(auth.userId);
      const data = await res.json();
      if (!data || !data.length){ tbodyPay.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ giao d·ªãch.</td></tr>'; return; }
      tbodyPay.innerHTML = data.map(p=>`
        <tr><td>${p.thoiGian ?? '-'}</td><td>${p.soTien ?? '-'}</td><td>${p.phuongThuc ?? '-'}</td><td>${p.trangThai ?? '-'}</td></tr>
      `).join('');
    }catch{ tbodyPay.innerHTML = '<tr><td colspan="4" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  }
  document.getElementById('payBtn').onclick = async ()=>{
    const amount = parseInt(document.getElementById('payAmount').value, 10) || 0;
    const note   = document.getElementById('payNote').value.trim();
    try{
      const res = await StudentAPI.createPayment(auth.userId, { soTien: amount, phuongThuc:'Online', ghiChu: note });
      if (!res.ok) throw new Error();
      alert('T·∫°o giao d·ªãch th√†nh c√¥ng!');
      loadPayments();
    }catch{ alert('L·ªói t·∫°o giao d·ªãch'); }
  };
  document.getElementById('momoBtn').onclick = async ()=>{
    const amount = parseInt(document.getElementById('payAmount').value, 10) || 0;
    try{
      const resp = await MomoAPI.create(String(amount), 'Thanh toan hoc phi');
      const data = await resp.json().catch(()=> ({}));
      const url = data.payUrl || data.redirectUrl || data.url;
      if (url) location.href = url;
      else alert('ƒê√£ t·∫°o giao d·ªãch MoMo (sandbox), nh∆∞ng ch∆∞a c√≥ URL tr·∫£ v·ªÅ.');
    }catch{ alert('Kh√¥ng t·∫°o ƒë∆∞·ª£c thanh to√°n MoMo'); }
  };

  // Schedule
  async function loadSchedule(){
    tbodySch.innerHTML = '<tr><td colspan="5" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await ScheduleAPI.me(); const data = await res.json();
      if (!data || !data.length){ tbodySch.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ l·ªãch.</td></tr>'; return; }
      tbodySch.innerHTML = data.map(s=>`
        <tr><td>${s.ngay}</td><td>${s.gioBatDau}</td><td>${s.gioKetThuc}</td><td>${s.maLopHoc}</td><td>${s.phongHoc ?? '-'}</td></tr>
      `).join('');
    }catch{ tbodySch.innerHTML = '<tr><td colspan="5" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  }

  loadOpenClasses(); loadPayments(); loadSchedule();
</script>
</body>
</html>
