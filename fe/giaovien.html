<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang Gi√°o vi√™n ‚Ä¢ EnglishCenter</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
<header class="site-header">
  <nav class="nav container">
    <a class="brand" href="index.html">EnglishCenter</a>
    <ul class="nav-list">
      <li class="active"><a href="giaovien.html">Trang gi√°o vi√™n</a></li>
      <li><a href="#" id="logoutBtn">ƒêƒÉng xu·∫•t</a></li>
    </ul>
  </nav>
</header>

<main class="container">
  <h1>Xin ch√†o, Gi√°o vi√™n üëã</h1>

  <section class="card">
    <h2>T·∫°o l·ªõp m·ªõi</h2>
    <div class="form grid-2">
      <label><span>T√™n l·ªõp</span><input id="tenLopHoc" type="text" placeholder="IELTS 6.5 - A1" /></label>
      <label><span>L·ªãch h·ªçc</span><input id="lichHoc" type="text" placeholder="T2-T4 18:00-20:00" /></label>
      <label><span>Ph√≤ng h·ªçc</span><input id="phongHoc" type="text" placeholder="P301" /></label>
      <label><span>M√£ kh√≥a h·ªçc (tu·ª≥)</span><input id="maKhoaHoc" type="number" placeholder="VD: 5" /></label>
      <div><button id="createClassBtn" class="btn">T·∫°o l·ªõp</button></div>
    </div>
  </section>

  <section class="card">
    <h2>C√°c l·ªõp ph·ª• tr√°ch</h2>
    <table id="classTbl">
      <thead><tr><th>M√£ l·ªõp</th><th>T√™n l·ªõp</th><th>Kh√≥a h·ªçc</th><th>Ph√≤ng</th><th>L·ªãch</th><th>Thao t√°c</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Th√™m h·ªçc vi√™n v√†o l·ªõp</h2>
    <div class="form grid-2">
      <label><span>M√£ l·ªõp</span><input id="addClassId" type="number" placeholder="VD: 101" /></label>
      <label><span>M√£ h·ªçc vi√™n</span><input id="addStudentId" type="number" placeholder="VD: 1001" /></label>
      <div><button id="addStudentBtn" class="btn">Th√™m</button></div>
    </div>
  </section>

  <section class="card">
    <h2>B√†i t·∫≠p c·ªßa l·ªõp</h2>
    <div class="form grid-2">
      <label><span>M√£ l·ªõp</span><input id="asmClassId" type="number" /></label>
      <div style="display:flex;gap:8px;align-items:flex-end;">
        <button id="loadAsmBtn" class="btn">T·∫£i b√†i t·∫≠p</button>
        <button id="createAsmBtn" class="btn btn-outline">T·∫°o b√†i t·∫≠p</button>
      </div>
      <label style="grid-column:1 / -1;"><span>Ti√™u ƒë·ªÅ b√†i t·∫≠p (khi t·∫°o)</span><input id="asmTitle" type="text" placeholder="Homework 01" /></label>
    </div>
    <table id="asmTbl">
      <thead><tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th><th>H·∫°n n·ªôp</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Nh·∫≠p ƒëi·ªÉm</h2>
    <div class="form grid-2">
      <label><span>M√£ h·ªçc vi√™n</span><input id="gradeHv" type="number" /></label>
      <label><span>M√£ l·ªõp</span><input id="gradeClass" type="number" /></label>
      <label><span>ƒêi·ªÉm</span><input id="gradeScore" type="number" step="0.1" /></label>
      <div><button id="gradeBtn" class="btn">L∆∞u ƒëi·ªÉm</button></div>
    </div>
  </section>
</main>

<footer class="site-footer"><div class="container"><p>¬© 2025 EnglishCenter.</p></div></footer>
<script src="assets/app.js"></script>
<script>
  const auth = requireRole('GiaoVien');
  if (!auth) throw new Error('No auth');

  const tbody = document.querySelector('#classTbl tbody');
  const tbodyAsm = document.querySelector('#asmTbl tbody');

  async function loadClasses(){
    tbody.innerHTML = '<tr><td colspan="6" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await TeacherAPI.listClasses(); const data = await res.json();
      if (!data || !data.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªõp.</td></tr>'; return; }
      tbody.innerHTML = data.map(l=>`
        <tr>
          <td>${l.maLopHoc ?? '-'}</td>
          <td>${l.tenLopHoc ?? '-'}</td>
          <td>${l.khoaHoc?.tenKhoaHoc ?? '-'}</td>
          <td>${l.phongHoc ?? '-'}</td>
          <td>${l.lichHoc ?? '-'}</td>
          <td>
            <button class="btn btn-sm" onclick="viewStudents(${l.maLopHoc})">H·ªçc vi√™n</button>
            <button class="btn btn-sm" onclick="delClass(${l.maLopHoc})">Xo√°</button>
          </td>
        </tr>`).join('');
    }catch{ tbody.innerHTML = '<tr><td colspan="6" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  }
  window.viewStudents = async (classId)=>{
    try{
      const res = await TeacherAPI.listStudents(classId); const data = await res.json();
      alert('H·ªçc vi√™n l·ªõp ' + classId + ':\n' + (data.map(d=> (d.hocVien?.taiKhoan?.hoTen || 'HV ' + (d.hocVien?.maHocVien||''))).join('\n') || '‚Äî'));
    }catch{ alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch'); }
  };
  window.delClass = async (id)=>{
    if (!confirm('Xo√° l·ªõp ' + id + '?')) return;
    try{ await TeacherAPI.deleteClass(id); loadClasses(); }catch{ alert('Xo√° th·∫•t b·∫°i'); }
  };

  document.getElementById('createClassBtn').onclick = async ()=>{
    const lopHoc = {
      tenLopHoc: document.getElementById('tenLopHoc').value.trim(),
      lichHoc: document.getElementById('lichHoc').value.trim(),
      phongHoc: document.getElementById('phongHoc').value.trim(),
      khoaHoc: (v=> v ? { maKhoaHoc: parseInt(v,10) } : null)(document.getElementById('maKhoaHoc').value)
    };
    try{ const r = await TeacherAPI.createClass(lopHoc); if (!r.ok) throw 0; alert('T·∫°o l·ªõp th√†nh c√¥ng'); loadClasses(); }
    catch{ alert('T·∫°o l·ªõp th·∫•t b·∫°i'); }
  };

  document.getElementById('addStudentBtn').onclick = async ()=>{
    const classId = parseInt(document.getElementById('addClassId').value, 10);
    const hvId    = parseInt(document.getElementById('addStudentId').value, 10);
    if (!classId || !hvId) { alert('Nh·∫≠p ƒë·ªß m√£ l·ªõp & m√£ h·ªçc vi√™n'); return; }
    try{
      const res = await TeacherAPI.addStudent(classId, { maHocVien: hvId });
      if (!res.ok) throw 0; alert('Th√™m h·ªçc vi√™n th√†nh c√¥ng');
    }catch{ alert('Th√™m h·ªçc vi√™n th·∫•t b·∫°i'); }
  };

  document.getElementById('loadAsmBtn').onclick = async ()=>{
    const classId = parseInt(document.getElementById('asmClassId').value, 10);
    if (!classId){ alert('Nh·∫≠p m√£ l·ªõp'); return; }
    tbodyAsm.innerHTML = '<tr><td colspan="3" class="muted">ƒêang t·∫£i...</td></tr>';
    try{
      const res = await TeacherAPI.listAssignments(classId); const data = await res.json();
      if (!data || !data.length){ tbodyAsm.innerHTML = '<tr><td colspan="3" class="muted">Ch∆∞a c√≥ b√†i t·∫≠p.</td></tr>'; return; }
      tbodyAsm.innerHTML = data.map(a=>`
        <tr><td>${a.id ?? '-'}</td><td>${a.tieuDe ?? '-'}</td><td>${a.hanNop ?? '-'}</td></tr>
      `).join('');
    }catch{ tbodyAsm.innerHTML = '<tr><td colspan="3" class="msg error">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>'; }
  };

  document.getElementById('createAsmBtn').onclick = async ()=>{
    const classId = parseInt(document.getElementById('asmClassId').value, 10);
    const title   = document.getElementById('asmTitle').value.trim();
    if (!classId || !title){ alert('Nh·∫≠p m√£ l·ªõp v√† ti√™u ƒë·ªÅ'); return; }
    const asm = { tieuDe: title, lopHoc: { id: classId } };
    try{ const r = await TeacherAPI.createAssignment(asm); if (!r.ok) throw 0; alert('T·∫°o b√†i t·∫≠p th√†nh c√¥ng'); }
    catch{ alert('T·∫°o b√†i t·∫≠p th·∫•t b·∫°i'); }
  };

  document.getElementById('gradeBtn').onclick = async ()=>{
    const hv  = parseInt(document.getElementById('gradeHv').value,10);
    const cls = parseInt(document.getElementById('gradeClass').value,10);
    const sc  = parseFloat(document.getElementById('gradeScore').value);
    if (!hv || !cls || isNaN(sc)){ alert('Nh·∫≠p ƒë·ªß th√¥ng tin'); return; }
    const diem = { hocVien: { maHocVien: hv }, lopHoc: { maLopHoc: cls }, diemSo: sc };
    try{ const r = await TeacherAPI.grade(diem); if (!r.ok) throw 0; alert('L∆∞u ƒëi·ªÉm th√†nh c√¥ng'); }
    catch{ alert('L∆∞u ƒëi·ªÉm th·∫•t b·∫°i'); }
  };

  loadClasses();
</script>
</body>
</html>
